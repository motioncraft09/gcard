<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Subscription Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#7c3aed',
                        'primary-light': '#8b5cf6',
                        'secondary': '#0ea5e9',
                        'accent': '#f59e0b',
                        'dark': '#0f172a',
                        'darker': '#0a0f1c',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            border-color: #7c3aed;
        }
        
        .status-active {
            background-color: #10b981;
            color: white;
        }
        
        .status-expired {
            background-color: #ef4444;
            color: white;
        }
        
        .status-pending {
            background-color: #f59e0b;
            color: white;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen font-inter">
    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="toast-message">Success!</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 py-4 px-6">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-slate-800">Admin Panel</h1>
                <p class="text-sm text-slate-500">Subscription Management</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-sm font-medium text-slate-800">Admin User</p>
                    <p class="text-xs text-slate-500">Last login: <span id="last-login">Just now</span></p>
                </div>
                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                    A
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Generate Codes -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">Generate Unlock Code</h2>
                    
                    <form id="generate-code-form" class="space-y-4">
                        <div>
                            <label for="user-id" class="block text-sm font-medium mb-2 text-slate-700">User ID</label>
                            <input type="text" id="user-id" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none input-focus text-slate-800" placeholder="Enter user ID or 'any' for generic code">
                            <p class="text-xs text-slate-500 mt-1">Use 'any' to create a code that works for any user</p>
                        </div>
                        
                        <div>
                            <label for="months" class="block text-sm font-medium mb-2 text-slate-700">Subscription Duration</label>
                            <select id="months" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none input-focus text-slate-800">
                                <option value="1">1 Month</option>
                                <option value="3" selected>3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">12 Months</option>
                                <option value="24">24 Months</option>
                                <option value="lifetime">Lifetime</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="custom-code" class="block text-sm font-medium mb-2 text-slate-700">Custom Code (Optional)</label>
                            <input type="text" id="custom-code" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none input-focus text-slate-800" placeholder="Leave empty for auto-generated code">
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-light transition-colors duration-300 card-shadow">
                            Generate Unlock Code
                        </button>
                    </form>
                    
                    <!-- Generated Code Display -->
                    <div id="generated-code-section" class="mt-6 hidden">
                        <h3 class="text-lg font-bold mb-3 text-slate-800">Generated Code</h3>
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-slate-700">Unlock Code:</span>
                                <button id="copy-code" class="text-primary hover:text-primary-light">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                            <p id="generated-code" class="font-mono text-lg font-bold text-slate-800"></p>
                            
                            <div class="mt-4">
                                <p class="text-sm text-slate-700 mb-1">Activation URL:</p>
                                <div class="flex">
                                    <input type="text" id="activation-url" readonly class="flex-grow px-3 py-2 bg-white border border-slate-200 rounded-l-lg text-sm text-slate-800">
                                    <button id="copy-url" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary-light">
                                        <i class="far fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="bg-white rounded-xl p-6 card-shadow mt-6">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Statistics</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-primary" id="total-users">0</p>
                            <p class="text-sm text-slate-600">Total Users</p>
                        </div>
                        
                        <div class="bg-slate-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-secondary" id="active-subscriptions">0</p>
                            <p class="text-sm text-slate-600">Active Subscriptions</p>
                        </div>
                        
                        <div class="bg-slate-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-accent" id="codes-generated">0</p>
                            <p class="text-sm text-slate-600">Codes Generated</p>
                        </div>
                        
                        <div class="bg-slate-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-green-500" id="revenue">$0</p>
                            <p class="text-sm text-slate-600">Estimated Revenue</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - User Management -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-slate-800">User Subscriptions</h2>
                        
                        <div class="flex space-x-2">
                            <input type="text" id="search-users" placeholder="Search users..." class="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none input-focus text-slate-800 text-sm">
                            <button id="refresh-data" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-700">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3">User ID</th>
                                    <th class="px-4 py-3">Status</th>
                                    <th class="px-4 py-3">Expiry Date</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 text-center text-slate-500 text-sm" id="no-users-message">
                        No users found. Users will appear here once they generate offers or activate premium.
                    </div>
                </div>
                
                <!-- Generated Codes List -->
                <div class="bg-white rounded-xl p-6 card-shadow mt-6">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">Generated Codes</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-700">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3">Code</th>
                                    <th class="px-4 py-3">User ID</th>
                                    <th class="px-4 py-3">Duration</th>
                                    <th class="px-4 py-3">Used</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="codes-table-body">
                                <!-- Codes will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 text-center text-slate-500 text-sm" id="no-codes-message">
                        No codes generated yet. Generate your first code using the form on the left.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateCodeForm = document.getElementById('generate-code-form');
            const generatedCodeSection = document.getElementById('generated-code-section');
            const generatedCodeElement = document.getElementById('generated-code');
            const activationUrlElement = document.getElementById('activation-url');
            const copyCodeBtn = document.getElementById('copy-code');
            const copyUrlBtn = document.getElementById('copy-url');
            const usersTableBody = document.getElementById('users-table-body');
            const codesTableBody = document.getElementById('codes-table-body');
            const noUsersMessage = document.getElementById('no-users-message');
            const noCodesMessage = document.getElementById('no-codes-message');
            const searchUsersInput = document.getElementById('search-users');
            const refreshDataBtn = document.getElementById('refresh-data');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // Stats elements
            const totalUsersElement = document.getElementById('total-users');
            const activeSubscriptionsElement = document.getElementById('active-subscriptions');
            const codesGeneratedElement = document.getElementById('codes-generated');
            const revenueElement = document.getElementById('revenue');
            
            // Initialize admin data if not exists
            function initializeAdminData() {
                if (!localStorage.getItem('adminCodes')) {
                    localStorage.setItem('adminCodes', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('adminLastLogin')) {
                    localStorage.setItem('adminLastLogin', new Date().toISOString());
                }
                
                // Set last login display
                const lastLogin = new Date(localStorage.getItem('adminLastLogin'));
                document.getElementById('last-login').textContent = formatDate(lastLogin);
                
                // Update last login time
                localStorage.setItem('adminLastLogin', new Date().toISOString());
            }
            
            // Format date for display
            function formatDate(date) {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // Show toast notification
            function showToast(message, type = 'success') {
                toastMessage.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // Generate a random code
            function generateRandomCode() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }
            
            // Get all users from localStorage
            function getAllUsers() {
                const users = [];
                
                // Get users with subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '{}');
                Object.keys(subscriptions).forEach(userId => {
                    users.push({
                        id: userId,
                        subscription: subscriptions[userId]
                    });
                });
                
                // Get users with usage data but no subscription
                const usageCount = localStorage.getItem('usageCount');
                const visitorId = localStorage.getItem('visitorId');
                
                if (visitorId && !subscriptions[visitorId]) {
                    users.push({
                        id: visitorId,
                        subscription: { active: false, expiry: null }
                    });
                }
                
                return users;
            }
            
            // Get all generated codes
            function getGeneratedCodes() {
                return JSON.parse(localStorage.getItem('adminCodes') || '[]');
            }
            
            // Save a generated code
            function saveGeneratedCode(code, userId, months, used = false) {
                const codes = getGeneratedCodes();
                
                codes.push({
                    code: code,
                    userId: userId,
                    months: months,
                    used: used,
                    createdAt: new Date().toISOString()
                });
                
                localStorage.setItem('adminCodes', JSON.stringify(codes));
            }
            
            // Update statistics
            function updateStatistics() {
                const users = getAllUsers();
                const codes = getGeneratedCodes();
                
                // Total users
                totalUsersElement.textContent = users.length;
                
                // Active subscriptions
                const activeSubs = users.filter(user => {
                    if (!user.subscription.active) return false;
                    
                    if (user.subscription.expiry) {
                        return new Date(user.subscription.expiry) > new Date();
                    }
                    
                    return true;
                }).length;
                
                activeSubscriptionsElement.textContent = activeSubs;
                
                // Codes generated
                codesGeneratedElement.textContent = codes.length;
                
                // Estimated revenue (assuming $3/month)
                let revenue = 0;
                users.forEach(user => {
                    if (user.subscription.active && user.subscription.expiry) {
                        const months = getSubscriptionMonths(user.subscription);
                        revenue += months * 3;
                    }
                });
                
                revenueElement.textContent = `$${revenue}`;
            }
            
            // Get subscription months from expiry date
            function getSubscriptionMonths(subscription) {
                if (!subscription.expiry) return 0;
                
                const now = new Date();
                const expiry = new Date(subscription.expiry);
                const diffTime = Math.abs(expiry - now);
                const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));
                
                return diffMonths;
            }
            
            // Render users table
            function renderUsersTable(searchTerm = '') {
                const users = getAllUsers();
                const filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                usersTableBody.innerHTML = '';
                
                if (filteredUsers.length === 0) {
                    noUsersMessage.classList.remove('hidden');
                    return;
                }
                
                noUsersMessage.classList.add('hidden');
                
                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    
                    const status = user.subscription.active ? 
                        (user.subscription.expiry && new Date(user.subscription.expiry) < new Date() ? 'expired' : 'active') : 
                        'inactive';
                    
                    const statusText = status === 'active' ? 'Active' : 
                                     status === 'expired' ? 'Expired' : 'Inactive';
                    
                    const statusClass = status === 'active' ? 'status-active' : 
                                      status === 'expired' ? 'status-expired' : 'bg-slate-100 text-slate-700';
                    
                    const expiryDate = user.subscription.expiry ? 
                        formatDate(new Date(user.subscription.expiry)) : 
                        'N/A';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-mono text-xs">${user.id}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-3">${expiryDate}</td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button class="text-primary hover:text-primary-light edit-user" data-user="${user.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 delete-user" data-user="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user');
                        editUser(userId);
                    });
                });
                
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user');
                        deleteUser(userId);
                    });
                });
            }
            
            // Render codes table
            function renderCodesTable() {
                const codes = getGeneratedCodes();
                codesTableBody.innerHTML = '';
                
                if (codes.length === 0) {
                    noCodesMessage.classList.remove('hidden');
                    return;
                }
                
                noCodesMessage.classList.add('hidden');
                
                // Sort codes by creation date (newest first)
                codes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                codes.forEach(code => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    
                    const usedStatus = code.used ? 'Yes' : 'No';
                    const usedClass = code.used ? 'status-active' : 'bg-slate-100 text-slate-700';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-mono font-bold">${code.code}</td>
                        <td class="px-4 py-3 font-mono text-xs">${code.userId}</td>
                        <td class="px-4 py-3">${code.months === 'lifetime' ? 'Lifetime' : `${code.months} months`}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${usedClass}">
                                ${usedStatus}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button class="text-primary hover:text-primary-light copy-code-row" data-code="${code.code}">
                                    <i class="far fa-copy"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 delete-code" data-code="${code.code}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    codesTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.copy-code-row').forEach(button => {
                    button.addEventListener('click', function() {
                        const code = this.getAttribute('data-code');
                        navigator.clipboard.writeText(code).then(() => {
                            showToast('Code copied to clipboard!');
                        });
                    });
                });
                
                document.querySelectorAll('.delete-code').forEach(button => {
                    button.addEventListener('click', function() {
                        const code = this.getAttribute('data-code');
                        deleteCode(code);
                    });
                });
            }
            
            // Edit user subscription
            function editUser(userId) {
                const users = getAllUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) return;
                
                const newMonths = prompt('Enter new subscription duration in months (or "lifetime" for permanent access):', 
                    user.subscription.expiry ? getSubscriptionMonths(user.subscription) : '12');
                
                if (newMonths === null) return;
                
                let months = parseInt(newMonths);
                let isLifetime = newMonths.toLowerCase() === 'lifetime';
                
                if (isNaN(months) && !isLifetime) {
                    showToast('Invalid duration entered', 'error');
                    return;
                }
                
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '{}');
                
                if (isLifetime) {
                    subscriptions[userId] = {
                        active: true,
                        expiry: null
                    };
                } else {
                    const expiry = new Date();
                    expiry.setMonth(expiry.getMonth() + months);
                    
                    subscriptions[userId] = {
                        active: true,
                        expiry: expiry.toISOString()
                    };
                }
                
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                
                showToast(`Subscription updated for user ${userId}`);
                renderUsersTable();
                updateStatistics();
            }
            
            // Delete user
            function deleteUser(userId) {
                if (!confirm(`Are you sure you want to delete user ${userId}? This will remove their subscription data.`)) {
                    return;
                }
                
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '{}');
                delete subscriptions[userId];
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                
                // Also remove usage count if this is the current visitor
                const visitorId = localStorage.getItem('visitorId');
                if (visitorId === userId) {
                    localStorage.removeItem('usageCount');
                }
                
                showToast(`User ${userId} deleted`);
                renderUsersTable();
                updateStatistics();
            }
            
            // Delete code
            function deleteCode(code) {
                if (!confirm(`Are you sure you want to delete code ${code}?`)) {
                    return;
                }
                
                const codes = getGeneratedCodes();
                const updatedCodes = codes.filter(c => c.code !== code);
                localStorage.setItem('adminCodes', JSON.stringify(updatedCodes));
                
                showToast(`Code ${code} deleted`);
                renderCodesTable();
                updateStatistics();
            }
            
            // Generate code form submission
            generateCodeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('user-id').value.trim();
                const months = document.getElementById('months').value;
                const customCode = document.getElementById('custom-code').value.trim();
                
                if (!userId) {
                    showToast('Please enter a User ID', 'error');
                    return;
                }
                
                // Generate code
                const code = customCode || generateRandomCode();
                
                // Save the code
                saveGeneratedCode(code, userId, months);
                
                // Generate activation URL
                const baseUrl = window.location.origin + window.location.pathname;
                const urlParams = new URLSearchParams();
                urlParams.set('unlock', code);
                
                if (userId !== 'any') {
                    urlParams.set('user', userId);
                }
                
                if (months !== 'lifetime') {
                    urlParams.set('months', months);
                }
                
                const activationUrl = `${baseUrl.replace('admin.html', 'index.html')}?${urlParams.toString()}`;
                
                // Display the generated code and URL
                generatedCodeElement.textContent = code;
                activationUrlElement.value = activationUrl;
                generatedCodeSection.classList.remove('hidden');
                
                showToast('Unlock code generated successfully!');
                
                // Reset form
                document.getElementById('user-id').value = '';
                document.getElementById('custom-code').value = '';
                
                // Update tables and statistics
                renderCodesTable();
                updateStatistics();
                
                // Scroll to the generated code section
                generatedCodeSection.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Copy code to clipboard
            copyCodeBtn.addEventListener('click', function() {
                const code = generatedCodeElement.textContent;
                navigator.clipboard.writeText(code).then(() => {
                    showToast('Code copied to clipboard!');
                });
            });
            
            // Copy URL to clipboard
            copyUrlBtn.addEventListener('click', function() {
                const url = activationUrlElement.value;
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Activation URL copied to clipboard!');
                });
            });
            
            // Search users
            searchUsersInput.addEventListener('input', function() {
                renderUsersTable(this.value);
            });
            
            // Refresh data
            refreshDataBtn.addEventListener('click', function() {
                renderUsersTable();
                renderCodesTable();
                updateStatistics();
                showToast('Data refreshed');
            });
            
            // Initialize the admin panel
            initializeAdminData();
            renderUsersTable();
            renderCodesTable();
            updateStatistics();
        });
    </script>
</body>
</html>
