function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    if (data.type === 'ADD_CERTIFICATE') {
      const certificate = data.data;
      const row = [
        certificate.certificateId,
        certificate.sellerName,
        certificate.sellerEmail,
        certificate.buyerName,
        certificate.buyerEmail,
        certificate.serviceDescription,
        certificate.budget,
        certificate.fees.fee,
        certificate.fees.total,
        certificate.guaranteePeriod,
        certificate.terms,
        certificate.status,
        certificate.createdAt,
        certificate.payment ? certificate.payment.method : '',
        certificate.payment ? certificate.payment.senderInfo : '',
        certificate.payment ? certificate.payment.paidAt : ''
      ];
      
      // Add headers if sheet is empty
      if (sheet.getLastRow() === 0) {
        const headers = [
          'Certificate ID', 'Seller Name', 'Seller Email', 'Buyer Name', 'Buyer Email',
          'Service Description', 'Budget', 'Fee', 'Total', 'Guarantee Period', 'Terms',
          'Status', 'Created At', 'Payment Method', 'Sender Info', 'Paid At'
        ];
        sheet.appendRow(headers);
      }
      
      sheet.appendRow(row);
      
      return ContentService
        .createTextOutput(JSON.stringify({status: 'success', message: 'Certificate stored successfully'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({status: 'error', message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    if (e.parameter.type === 'GET_CERTIFICATE' && e.parameter.id) {
      const certificateId = e.parameter.id;
      
      // Skip headers row
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === certificateId) {
          const certificate = {};
          headers.forEach((header, index) => {
            certificate[header] = data[i][index];
          });
          
          return ContentService
            .createTextOutput(JSON.stringify({status: 'success', certificate}))
            .setMimeType(ContentService.MimeType.JSON);
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({status: 'error', message: 'Certificate not found'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({status: 'error', message: 'Invalid request'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({status: 'error', message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
